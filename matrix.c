//*****************************************************************************

#include "matrix.h"
#include "rgbmatrix.h"

#include <stdlib.h>
#include <string.h>
#include <assert.h>

// https://github.com/hzeller/rpi-rgb-led-matrix/blob/master/README.md#changing-parameters-via-command-line-flags
static const char *matrix_argv[] =
{
  "",
  "--led-cols=64",
  "--led-rows=64",
  "--led-slowdown-gpio=2",
  "--led-chain=1", // number of daisy-chained panels
  "--led-gpio-mapping=adafruit-hat-pwm",
  NULL
};

static struct RGBLedMatrixOptions matrix_options;
static struct RGBLedMatrix *matrix = NULL;
static struct LedCanvas *matrix_buffer;

//*****************************************************************************

void matrix_create()
{
  assert(!matrix);
  memset(&matrix_options, 0, sizeof(matrix_options));
  matrix = led_matrix_create_from_options_const_argv(&matrix_options, 4, (char**)matrix_argv);
  assert(matrix);
  matrix_buffer = led_matrix_create_offscreen_canvas(matrix);
}

//*****************************************************************************

void matrix_set_raw(uint8_t x, uint8_t y, uint8_t r, uint8_t g, uint8_t b)
{
  assert(matrix);
  assert(x < MATRIX_WIDTH);
  assert(y < MATRIX_HEIGHT);
  led_canvas_set_pixel(matrix_buffer, x, y, r, g, b);
}

//*****************************************************************************

void matrix_flush()
{
  assert(matrix);
  matrix_buffer = led_matrix_swap_on_vsync(matrix, matrix_buffer);
  led_canvas_clear(matrix_buffer);
}

//*****************************************************************************

void matrix_free()
{
  assert(matrix);
  matrix_flush();
  matrix_flush();
  led_matrix_delete(matrix);
  matrix = NULL;
}

//*****************************************************************************

static uint8_t gamma[256] =
{
  [0] = 0,
  [1] = 0,
  [2] = 0,
  [3] = 0,
  [4] = 0,
  [5] = 0,
  [6] = 1,
  [7] = 1,
  [8] = 1,
  [9] = 1,
  [10] = 1,
  [11] = 2,
  [12] = 2,
  [13] = 2,
  [14] = 2,
  [15] = 3,
  [16] = 3,
  [17] = 3,
  [18] = 4,
  [19] = 4,
  [20] = 4,
  [21] = 5,
  [22] = 5,
  [23] = 5,
  [24] = 6,
  [25] = 6,
  [26] = 7,
  [27] = 7,
  [28] = 7,
  [29] = 8,
  [30] = 8,
  [31] = 9,
  [32] = 9,
  [33] = 10,
  [34] = 10,
  [35] = 11,
  [36] = 11,
  [37] = 12,
  [38] = 12,
  [39] = 13,
  [40] = 13,
  [41] = 14,
  [42] = 14,
  [43] = 15,
  [44] = 15,
  [45] = 16,
  [46] = 16,
  [47] = 17,
  [48] = 18,
  [49] = 18,
  [50] = 19,
  [51] = 19,
  [52] = 20,
  [53] = 21,
  [54] = 21,
  [55] = 22,
  [56] = 23,
  [57] = 23,
  [58] = 24,
  [59] = 25,
  [60] = 25,
  [61] = 26,
  [62] = 27,
  [63] = 27,
  [64] = 28,
  [65] = 29,
  [66] = 29,
  [67] = 30,
  [68] = 31,
  [69] = 31,
  [70] = 32,
  [71] = 33,
  [72] = 34,
  [73] = 34,
  [74] = 35,
  [75] = 36,
  [76] = 37,
  [77] = 38,
  [78] = 38,
  [79] = 39,
  [80] = 40,
  [81] = 41,
  [82] = 42,
  [83] = 42,
  [84] = 43,
  [85] = 44,
  [86] = 45,
  [87] = 46,
  [88] = 46,
  [89] = 47,
  [90] = 48,
  [91] = 49,
  [92] = 50,
  [93] = 51,
  [94] = 52,
  [95] = 53,
  [96] = 53,
  [97] = 54,
  [98] = 55,
  [99] = 56,
  [100] = 57,
  [101] = 58,
  [102] = 59,
  [103] = 60,
  [104] = 61,
  [105] = 62,
  [106] = 63,
  [107] = 64,
  [108] = 64,
  [109] = 65,
  [110] = 66,
  [111] = 67,
  [112] = 68,
  [113] = 69,
  [114] = 70,
  [115] = 71,
  [116] = 72,
  [117] = 73,
  [118] = 74,
  [119] = 75,
  [120] = 76,
  [121] = 77,
  [122] = 78,
  [123] = 79,
  [124] = 80,
  [125] = 81,
  [126] = 83,
  [127] = 84,
  [128] = 85,
  [129] = 86,
  [130] = 87,
  [131] = 88,
  [132] = 89,
  [133] = 90,
  [134] = 91,
  [135] = 92,
  [136] = 93,
  [137] = 94,
  [138] = 95,
  [139] = 97,
  [140] = 98,
  [141] = 99,
  [142] = 100,
  [143] = 101,
  [144] = 102,
  [145] = 103,
  [146] = 104,
  [147] = 106,
  [148] = 107,
  [149] = 108,
  [150] = 109,
  [151] = 110,
  [152] = 111,
  [153] = 113,
  [154] = 114,
  [155] = 115,
  [156] = 116,
  [157] = 117,
  [158] = 119,
  [159] = 120,
  [160] = 121,
  [161] = 122,
  [162] = 123,
  [163] = 125,
  [164] = 126,
  [165] = 127,
  [166] = 128,
  [167] = 130,
  [168] = 131,
  [169] = 132,
  [170] = 133,
  [171] = 135,
  [172] = 136,
  [173] = 137,
  [174] = 138,
  [175] = 140,
  [176] = 141,
  [177] = 142,
  [178] = 143,
  [179] = 145,
  [180] = 146,
  [181] = 147,
  [182] = 149,
  [183] = 150,
  [184] = 151,
  [185] = 153,
  [186] = 154,
  [187] = 155,
  [188] = 157,
  [189] = 158,
  [190] = 159,
  [191] = 161,
  [192] = 162,
  [193] = 163,
  [194] = 165,
  [195] = 166,
  [196] = 167,
  [197] = 169,
  [198] = 170,
  [199] = 171,
  [200] = 173,
  [201] = 174,
  [202] = 176,
  [203] = 177,
  [204] = 178,
  [205] = 180,
  [206] = 181,
  [207] = 183,
  [208] = 184,
  [209] = 185,
  [210] = 187,
  [211] = 188,
  [212] = 190,
  [213] = 191,
  [214] = 193,
  [215] = 194,
  [216] = 196,
  [217] = 197,
  [218] = 198,
  [219] = 200,
  [220] = 201,
  [221] = 203,
  [222] = 204,
  [223] = 206,
  [224] = 207,
  [225] = 209,
  [226] = 210,
  [227] = 212,
  [228] = 213,
  [229] = 215,
  [230] = 216,
  [231] = 218,
  [232] = 219,
  [233] = 221,
  [234] = 222,
  [235] = 224,
  [236] = 225,
  [237] = 227,
  [238] = 228,
  [239] = 230,
  [240] = 231,
  [241] = 233,
  [242] = 235,
  [243] = 236,
  [244] = 238,
  [245] = 239,
  [246] = 241,
  [247] = 242,
  [248] = 244,
  [249] = 245,
  [250] = 247,
  [251] = 249,
  [252] = 250,
  [253] = 252,
  [254] = 253,
  [255] = 255,
};

//*****************************************************************************

static uint8_t rgb[256][3] =
{
  [0] = { 255, 20, 20 },
  [1] = { 251, 23, 19 },
  [2] = { 251, 24, 17 },
  [3] = { 251, 26, 15 },
  [4] = { 251, 27, 12 },
  [5] = { 251, 29, 10 },
  [6] = { 251, 30, 7 },
  [7] = { 251, 32, 5 },
  [8] = { 255, 32, 0 },
  [9] = { 251, 35, 0 },
  [10] = { 247, 39, 0 },
  [11] = { 244, 42, 0 },
  [12] = { 240, 45, 0 },
  [13] = { 237, 48, 0 },
  [14] = { 233, 51, 0 },
  [15] = { 230, 54, 0 },
  [16] = { 227, 57, 0 },
  [17] = { 224, 59, 0 },
  [18] = { 221, 62, 0 },
  [19] = { 218, 65, 0 },
  [20] = { 215, 67, 0 },
  [21] = { 212, 70, 0 },
  [22] = { 209, 72, 0 },
  [23] = { 207, 74, 0 },
  [24] = { 204, 77, 0 },
  [25] = { 201, 79, 0 },
  [26] = { 199, 81, 0 },
  [27] = { 197, 83, 0 },
  [28] = { 194, 85, 0 },
  [29] = { 192, 87, 0 },
  [30] = { 190, 89, 0 },
  [31] = { 188, 91, 0 },
  [32] = { 185, 93, 0 },
  [33] = { 183, 95, 0 },
  [34] = { 181, 96, 0 },
  [35] = { 179, 98, 0 },
  [36] = { 177, 100, 0 },
  [37] = { 175, 101, 0 },
  [38] = { 174, 103, 0 },
  [39] = { 172, 105, 0 },
  [40] = { 170, 106, 0 },
  [41] = { 168, 108, 0 },
  [42] = { 167, 109, 0 },
  [43] = { 165, 111, 0 },
  [44] = { 163, 112, 0 },
  [45] = { 162, 114, 0 },
  [46] = { 160, 115, 0 },
  [47] = { 158, 116, 0 },
  [48] = { 157, 118, 0 },
  [49] = { 155, 119, 0 },
  [50] = { 154, 120, 0 },
  [51] = { 153, 122, 0 },
  [52] = { 151, 123, 0 },
  [53] = { 150, 124, 0 },
  [54] = { 148, 125, 0 },
  [55] = { 147, 126, 0 },
  [56] = { 146, 128, 0 },
  [57] = { 144, 129, 0 },
  [58] = { 143, 130, 0 },
  [59] = { 142, 131, 0 },
  [60] = { 141, 132, 0 },
  [61] = { 139, 133, 0 },
  [62] = { 138, 134, 0 },
  [63] = { 137, 135, 0 },
  [64] = { 136, 136, 0 },
  [65] = { 135, 137, 0 },
  [66] = { 134, 138, 0 },
  [67] = { 133, 139, 0 },
  [68] = { 131, 140, 0 },
  [69] = { 130, 141, 0 },
  [70] = { 129, 142, 0 },
  [71] = { 128, 143, 0 },
  [72] = { 126, 144, 0 },
  [73] = { 125, 146, 0 },
  [74] = { 124, 147, 0 },
  [75] = { 122, 148, 0 },
  [76] = { 121, 149, 0 },
  [77] = { 120, 150, 0 },
  [78] = { 118, 151, 0 },
  [79] = { 117, 153, 0 },
  [80] = { 115, 154, 0 },
  [81] = { 114, 155, 0 },
  [82] = { 113, 157, 0 },
  [83] = { 111, 158, 0 },
  [84] = { 109, 159, 0 },
  [85] = { 108, 161, 0 },
  [86] = { 106, 162, 0 },
  [87] = { 105, 163, 0 },
  [88] = { 103, 165, 0 },
  [89] = { 101, 166, 0 },
  [90] = { 100, 168, 0 },
  [91] = { 98, 169, 0 },
  [92] = { 96, 171, 0 },
  [93] = { 94, 172, 0 },
  [94] = { 92, 174, 0 },
  [95] = { 91, 176, 0 },
  [96] = { 89, 177, 0 },
  [97] = { 87, 179, 0 },
  [98] = { 85, 181, 0 },
  [99] = { 83, 183, 0 },
  [100] = { 81, 184, 0 },
  [101] = { 79, 186, 0 },
  [102] = { 76, 188, 0 },
  [103] = { 74, 190, 0 },
  [104] = { 72, 192, 0 },
  [105] = { 70, 194, 0 },
  [106] = { 67, 196, 0 },
  [107] = { 65, 198, 0 },
  [108] = { 63, 200, 0 },
  [109] = { 60, 202, 0 },
  [110] = { 58, 205, 0 },
  [111] = { 55, 207, 0 },
  [112] = { 52, 209, 0 },
  [113] = { 50, 212, 0 },
  [114] = { 47, 214, 0 },
  [115] = { 44, 217, 0 },
  [116] = { 41, 219, 0 },
  [117] = { 38, 222, 0 },
  [118] = { 35, 224, 0 },
  [119] = { 32, 227, 0 },
  [120] = { 29, 230, 0 },
  [121] = { 25, 233, 0 },
  [122] = { 22, 236, 0 },
  [123] = { 19, 239, 0 },
  [124] = { 15, 242, 0 },
  [125] = { 11, 245, 0 },
  [126] = { 8, 248, 0 },
  [127] = { 4, 252, 0 },
  [128] = { 0, 255, 0 },
  [129] = { 0, 250, 8 },
  [130] = { 0, 245, 15 },
  [131] = { 0, 241, 23 },
  [132] = { 0, 237, 30 },
  [133] = { 0, 232, 36 },
  [134] = { 0, 228, 43 },
  [135] = { 0, 224, 49 },
  [136] = { 0, 221, 55 },
  [137] = { 0, 217, 61 },
  [138] = { 0, 213, 67 },
  [139] = { 0, 210, 72 },
  [140] = { 0, 207, 77 },
  [141] = { 0, 203, 83 },
  [142] = { 0, 200, 88 },
  [143] = { 0, 197, 92 },
  [144] = { 0, 194, 97 },
  [145] = { 0, 191, 102 },
  [146] = { 0, 189, 106 },
  [147] = { 0, 186, 110 },
  [148] = { 0, 183, 115 },
  [149] = { 0, 181, 119 },
  [150] = { 0, 178, 123 },
  [151] = { 0, 176, 126 },
  [152] = { 0, 174, 130 },
  [153] = { 0, 171, 134 },
  [154] = { 0, 169, 137 },
  [155] = { 0, 167, 141 },
  [156] = { 0, 165, 144 },
  [157] = { 0, 163, 148 },
  [158] = { 0, 161, 151 },
  [159] = { 0, 159, 154 },
  [160] = { 0, 157, 157 },
  [161] = { 0, 155, 160 },
  [162] = { 0, 153, 163 },
  [163] = { 0, 151, 167 },
  [164] = { 0, 149, 170 },
  [165] = { 0, 146, 174 },
  [166] = { 0, 144, 177 },
  [167] = { 0, 142, 181 },
  [168] = { 0, 139, 185 },
  [169] = { 0, 136, 190 },
  [170] = { 0, 134, 194 },
  [171] = { 0, 131, 199 },
  [172] = { 0, 128, 204 },
  [173] = { 0, 124, 209 },
  [174] = { 0, 121, 215 },
  [175] = { 0, 117, 221 },
  [176] = { 0, 113, 227 },
  [177] = { 0, 109, 233 },
  [178] = { 0, 105, 240 },
  [179] = { 0, 100, 247 },
  [180] = { 0, 96, 255 },
  [181] = { 7, 91, 251 },
  [182] = { 12, 87, 251 },
  [183] = { 17, 83, 251 },
  [184] = { 20, 78, 255 },
  [185] = { 24, 75, 254 },
  [186] = { 29, 71, 254 },
  [187] = { 33, 68, 253 },
  [188] = { 38, 64, 252 },
  [189] = { 42, 61, 252 },
  [190] = { 44, 57, 254 },
  [191] = { 48, 55, 253 },
  [192] = { 52, 52, 252 },
  [193] = { 55, 48, 254 },
  [194] = { 59, 46, 252 },
  [195] = { 62, 42, 254 },
  [196] = { 66, 40, 252 },
  [197] = { 70, 36, 254 },
  [198] = { 74, 33, 252 },
  [199] = { 78, 29, 253 },
  [200] = { 82, 24, 254 },
  [201] = { 87, 22, 252 },
  [202] = { 91, 17, 253 },
  [203] = { 96, 12, 254 },
  [204] = { 100, 10, 251 },
  [205] = { 105, 5, 252 },
  [206] = { 111, 0, 253 },
  [207] = { 115, 0, 246 },
  [208] = { 120, 0, 240 },
  [209] = { 124, 0, 234 },
  [210] = { 128, 0, 228 },
  [211] = { 132, 0, 223 },
  [212] = { 136, 0, 218 },
  [213] = { 140, 0, 213 },
  [214] = { 143, 0, 208 },
  [215] = { 146, 0, 203 },
  [216] = { 149, 0, 199 },
  [217] = { 152, 0, 195 },
  [218] = { 155, 0, 191 },
  [219] = { 158, 0, 187 },
  [220] = { 160, 0, 183 },
  [221] = { 163, 0, 180 },
  [222] = { 165, 0, 176 },
  [223] = { 168, 0, 173 },
  [224] = { 170, 0, 170 },
  [225] = { 172, 0, 167 },
  [226] = { 175, 0, 164 },
  [227] = { 177, 0, 160 },
  [228] = { 179, 0, 157 },
  [229] = { 182, 0, 153 },
  [230] = { 184, 0, 150 },
  [231] = { 187, 0, 146 },
  [232] = { 190, 0, 142 },
  [233] = { 193, 0, 138 },
  [234] = { 195, 0, 134 },
  [235] = { 198, 0, 130 },
  [236] = { 201, 0, 126 },
  [237] = { 205, 0, 122 },
  [238] = { 208, 0, 117 },
  [239] = { 211, 0, 112 },
  [240] = { 215, 0, 107 },
  [241] = { 218, 0, 102 },
  [242] = { 222, 0, 97 },
  [243] = { 226, 0, 92 },
  [244] = { 230, 0, 86 },
  [245] = { 234, 0, 80 },
  [246] = { 238, 0, 74 },
  [247] = { 243, 0, 68 },
  [248] = { 247, 0, 62 },
  [249] = { 252, 0, 55 },
  [250] = { 253, 3, 50 },
  [251] = { 254, 5, 44 },
  [252] = { 251, 10, 40 },
  [253] = { 252, 12, 35 },
  [254] = { 253, 15, 30 },
  [255] = { 254, 17, 25 },
};

//*****************************************************************************

void matrix_set_rgb(uint8_t x, uint8_t y, uint8_t r, uint8_t g, uint8_t b)
{
  matrix_set_raw(x, y, gamma[r], gamma[g], gamma[b]);
}

//*****************************************************************************
void matrix_set_g(uint8_t x, uint8_t y, uint8_t v)
{
  matrix_set_raw(x, y, gamma[v], gamma[v], gamma[v]);
}

//*****************************************************************************

void matrix_set_hv(uint8_t x, uint8_t y, uint8_t h, uint8_t v)
{
  uint8_t r = rgb[h][0];
  uint8_t g = rgb[h][1];
  uint8_t b = rgb[h][2];
  if (v < 255)
  {
    uint16_t f = (uint16_t)gamma[v];
    r = (uint8_t)(((uint16_t)r * f) >> 8);
    g = (uint8_t)(((uint16_t)g * f) >> 8);
    b = (uint8_t)(((uint16_t)b * f) >> 8);
  }
  matrix_set_raw(x, y, r, g, b);
}

//*****************************************************************************
