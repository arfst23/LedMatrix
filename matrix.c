//*****************************************************************************

#include "matrix.h"

#include "led-matrix-c.h"
#include <stdlib.h>
#include <string.h>
#include <assert.h>

static const char *matrix_argv[] =
{
  "",
  "--led-cols=64",
  "--led-rows=64",
  "--led-slowdown-gpio=2",
  NULL
};

static struct RGBLedMatrixOptions matrix_options;
static struct RGBLedMatrix *matrix = NULL;
static struct LedCanvas *matrix_buffer;

//*****************************************************************************

void matrix_create()
{
  assert(!matrix);
  memset(&matrix_options, 0, sizeof(matrix_options));
  matrix = led_matrix_create_from_options_const_argv(&matrix_options, 4, (char**)matrix_argv);
  assert(matrix);
  matrix_buffer = led_matrix_create_offscreen_canvas(matrix);
}

//*****************************************************************************

void matrix_set_rgb(uint8_t x, uint8_t y, uint8_t r, uint8_t g, uint8_t b)
{
  assert(matrix);
  assert(x < MATRIX_WIDTH);
  assert(y < MATRIX_HEIGHT);
  led_canvas_set_pixel(matrix_buffer, x, y, r, g, b);
}

//*****************************************************************************

void matrix_flush()
{
  assert(matrix);
  matrix_buffer = led_matrix_swap_on_vsync(matrix, matrix_buffer);
}

//*****************************************************************************

void matrix_free()
{
  assert(matrix);
  led_matrix_delete(matrix);
  matrix = NULL;
}

//*****************************************************************************
// >>> rgb

static uint8_t rgb[256][3] =
{
  { 251,   0,   0 }, // 0
  { 250,   3,   0 }, // 1
  { 250,   7,   0 }, // 2
  { 250,  11,   0 }, // 3
  { 250,  15,   0 }, // 4
  { 249,  19,   0 }, // 5
  { 249,  23,   0 }, // 6
  { 249,  27,   0 }, // 7
  { 249,  31,   0 }, // 8
  { 248,  34,   0 }, // 9
  { 248,  38,   0 }, // 10
  { 248,  42,   0 }, // 11
  { 248,  46,   0 }, // 12
  { 247,  50,   0 }, // 13
  { 247,  54,   0 }, // 14
  { 247,  58,   0 }, // 15
  { 247,  62,   0 }, // 16
  { 247,  65,   0 }, // 17
  { 247,  69,   0 }, // 18
  { 247,  73,   0 }, // 19
  { 247,  77,   0 }, // 20
  { 247,  81,   0 }, // 21
  { 247,  85,   0 }, // 22
  { 247,  89,   0 }, // 23
  { 247,  93,   0 }, // 24
  { 247,  96,   0 }, // 25
  { 247, 100,   0 }, // 26
  { 247, 104,   0 }, // 27
  { 247, 108,   0 }, // 28
  { 247, 112,   0 }, // 29
  { 247, 116,   0 }, // 30
  { 247, 120,   0 }, // 31
  { 247, 124,   0 }, // 32
  { 246, 127,   0 }, // 33
  { 246, 130,   0 }, // 34
  { 245, 133,   0 }, // 35
  { 245, 136,   0 }, // 36
  { 244, 139,   0 }, // 37
  { 244, 142,   0 }, // 38
  { 243, 145,   0 }, // 39
  { 243, 148,   0 }, // 40
  { 242, 151,   0 }, // 41
  { 242, 154,   0 }, // 42
  { 241, 157,   0 }, // 43
  { 241, 160,   0 }, // 44
  { 240, 163,   0 }, // 45
  { 240, 166,   0 }, // 46
  { 239, 169,   0 }, // 47
  { 239, 172,   0 }, // 48
  { 238, 175,   0 }, // 49
  { 238, 179,   0 }, // 50
  { 238, 183,   0 }, // 51
  { 238, 187,   0 }, // 52
  { 237, 191,   0 }, // 53
  { 237, 195,   0 }, // 54
  { 237, 199,   0 }, // 55
  { 237, 203,   0 }, // 56
  { 236, 207,   0 }, // 57
  { 236, 211,   0 }, // 58
  { 236, 215,   0 }, // 59
  { 236, 219,   0 }, // 60
  { 235, 223,   0 }, // 61
  { 235, 227,   0 }, // 62
  { 235, 231,   0 }, // 63
  { 235, 235,   0 }, // 64
  { 232, 235,   0 }, // 65
  { 229, 236,   0 }, // 66
  { 226, 236,   0 }, // 67
  { 223, 237,   0 }, // 68
  { 220, 237,   0 }, // 69
  { 217, 238,   0 }, // 70
  { 214, 238,   0 }, // 71
  { 212, 239,   0 }, // 72
  { 209, 239,   0 }, // 73
  { 206, 240,   0 }, // 74
  { 203, 240,   0 }, // 75
  { 200, 241,   0 }, // 76
  { 197, 241,   0 }, // 77
  { 194, 242,   0 }, // 78
  { 191, 242,   0 }, // 79
  { 189, 243,   0 }, // 80
  { 185, 243,   0 }, // 81
  { 181, 243,   0 }, // 82
  { 177, 243,   0 }, // 83
  { 173, 243,   0 }, // 84
  { 169, 243,   0 }, // 85
  { 166, 243,   0 }, // 86
  { 162, 243,   0 }, // 87
  { 158, 243,   0 }, // 88
  { 154, 243,   0 }, // 89
  { 150, 243,   0 }, // 90
  { 147, 243,   0 }, // 91
  { 143, 243,   0 }, // 92
  { 139, 243,   0 }, // 93
  { 135, 243,   0 }, // 94
  { 131, 243,   0 }, // 95
  { 128, 243,   0 }, // 96
  { 123, 243,   0 }, // 97
  { 118, 243,   0 }, // 98
  { 113, 243,   0 }, // 99
  { 109, 244,   0 }, // 100
  { 104, 244,   0 }, // 101
  {  99, 244,   0 }, // 102
  {  95, 244,   0 }, // 103
  {  90, 245,   0 }, // 104
  {  85, 245,   0 }, // 105
  {  81, 245,   0 }, // 106
  {  76, 245,   0 }, // 107
  {  71, 246,   0 }, // 108
  {  67, 246,   0 }, // 109
  {  62, 246,   0 }, // 110
  {  57, 246,   0 }, // 111
  {  53, 247,   0 }, // 112
  {  49, 247,   5 }, // 113
  {  46, 248,  10 }, // 114
  {  43, 248,  15 }, // 115
  {  39, 249,  20 }, // 116
  {  36, 249,  25 }, // 117
  {  33, 250,  30 }, // 118
  {  29, 250,  35 }, // 119
  {  26, 251,  40 }, // 120
  {  23, 251,  45 }, // 121
  {  19, 252,  50 }, // 122
  {  16, 252,  55 }, // 123
  {  13, 253,  60 }, // 124
  {   9, 253,  65 }, // 125
  {   6, 254,  70 }, // 126
  {   3, 254,  75 }, // 127
  {   0, 255,  80 }, // 128
  {   0, 254,  83 }, // 129
  {   0, 254,  87 }, // 130
  {   0, 254,  91 }, // 131
  {   0, 254,  95 }, // 132
  {   0, 253,  99 }, // 133
  {   0, 253, 102 }, // 134
  {   0, 253, 106 }, // 135
  {   0, 253, 110 }, // 136
  {   0, 252, 114 }, // 137
  {   0, 252, 118 }, // 138
  {   0, 252, 121 }, // 139
  {   0, 252, 125 }, // 140
  {   0, 251, 129 }, // 141
  {   0, 251, 133 }, // 142
  {   0, 251, 137 }, // 143
  {   0, 251, 141 }, // 144
  {   0, 250, 147 }, // 145
  {   0, 250, 153 }, // 146
  {   0, 249, 160 }, // 147
  {   0, 249, 166 }, // 148
  {   0, 248, 172 }, // 149
  {   0, 248, 179 }, // 150
  {   0, 247, 185 }, // 151
  {   0, 247, 192 }, // 152
  {   0, 246, 198 }, // 153
  {   0, 246, 204 }, // 154
  {   0, 245, 211 }, // 155
  {   0, 245, 217 }, // 156
  {   0, 244, 223 }, // 157
  {   0, 244, 230 }, // 158
  {   0, 243, 236 }, // 159
  {   0, 243, 243 }, // 160
  {   1, 238, 243 }, // 161
  {   3, 234, 244 }, // 162
  {   5, 229, 245 }, // 163
  {   7, 225, 246 }, // 164
  {   9, 220, 246 }, // 165
  {  11, 216, 247 }, // 166
  {  13, 211, 248 }, // 167
  {  15, 207, 249 }, // 168
  {  16, 202, 249 }, // 169
  {  18, 198, 250 }, // 170
  {  20, 193, 251 }, // 171
  {  22, 189, 252 }, // 172
  {  24, 184, 252 }, // 173
  {  26, 180, 253 }, // 174
  {  28, 175, 254 }, // 175
  {  30, 171, 255 }, // 176
  {  34, 167, 255 }, // 177
  {  38, 163, 255 }, // 178
  {  42, 160, 255 }, // 179
  {  46, 156, 255 }, // 180
  {  50, 153, 255 }, // 181
  {  54, 149, 255 }, // 182
  {  58, 146, 255 }, // 183
  {  62, 142, 255 }, // 184
  {  66, 138, 255 }, // 185
  {  70, 135, 255 }, // 186
  {  74, 131, 255 }, // 187
  {  78, 128, 255 }, // 188
  {  82, 124, 255 }, // 189
  {  86, 121, 255 }, // 190
  {  90, 117, 255 }, // 191
  {  94, 114, 255 }, // 192
  {  99, 112, 255 }, // 193
  { 104, 111, 255 }, // 194
  { 109, 110, 255 }, // 195
  { 114, 109, 255 }, // 196
  { 119, 107, 255 }, // 197
  { 124, 106, 255 }, // 198
  { 129, 105, 255 }, // 199
  { 134, 104, 255 }, // 200
  { 139, 102, 255 }, // 201
  { 144, 101, 255 }, // 202
  { 149, 100, 255 }, // 203
  { 154,  99, 255 }, // 204
  { 159,  97, 255 }, // 205
  { 164,  96, 255 }, // 206
  { 169,  95, 255 }, // 207
  { 175,  94, 255 }, // 208
  { 180,  89, 255 }, // 209
  { 185,  84, 255 }, // 210
  { 190,  79, 255 }, // 211
  { 195,  75, 255 }, // 212
  { 200,  70, 255 }, // 213
  { 205,  65, 255 }, // 214
  { 210,  60, 255 }, // 215
  { 215,  56, 255 }, // 216
  { 220,  51, 255 }, // 217
  { 225,  46, 255 }, // 218
  { 230,  41, 255 }, // 219
  { 235,  37, 255 }, // 220
  { 240,  32, 255 }, // 221
  { 245,  27, 255 }, // 222
  { 250,  22, 255 }, // 223
  { 255,  18, 255 }, // 224
  { 255,  18, 247 }, // 225
  { 255,  18, 240 }, // 226
  { 255,  18, 232 }, // 227
  { 255,  18, 225 }, // 228
  { 255,  18, 217 }, // 229
  { 255,  18, 210 }, // 230
  { 255,  18, 202 }, // 231
  { 255,  18, 195 }, // 232
  { 255,  18, 188 }, // 233
  { 255,  18, 180 }, // 234
  { 255,  18, 173 }, // 235
  { 255,  18, 165 }, // 236
  { 255,  18, 158 }, // 237
  { 255,  18, 150 }, // 238
  { 255,  18, 143 }, // 239
  { 255,  18, 136 }, // 240
  { 254,  16, 127 }, // 241
  { 254,  15, 119 }, // 242
  { 254,  14, 110 }, // 243
  { 254,  13, 102 }, // 244
  { 253,  12,  93 }, // 245
  { 253,  11,  85 }, // 246
  { 253,  10,  76 }, // 247
  { 253,   9,  68 }, // 248
  { 252,   7,  59 }, // 249
  { 252,   6,  51 }, // 250
  { 252,   5,  42 }, // 251
  { 252,   4,  34 }, // 252
  { 251,   3,  25 }, // 253
  { 251,   2,  17 }, // 254
  { 251,   1,   8 }, // 255
};

// <<<
//*****************************************************************************
// >>> vf

static uint8_t vf[255] =
{
    0, // 0
    0, // 1
    0, // 2
    0, // 3
    0, // 4
    0, // 5
    1, // 6
    1, // 7
    1, // 8
    1, // 9
    1, // 10
    2, // 11
    2, // 12
    2, // 13
    2, // 14
    3, // 15
    3, // 16
    3, // 17
    4, // 18
    4, // 19
    4, // 20
    5, // 21
    5, // 22
    5, // 23
    6, // 24
    6, // 25
    7, // 26
    7, // 27
    7, // 28
    8, // 29
    8, // 30
    9, // 31
    9, // 32
   10, // 33
   10, // 34
   11, // 35
   11, // 36
   12, // 37
   12, // 38
   13, // 39
   13, // 40
   14, // 41
   14, // 42
   15, // 43
   15, // 44
   16, // 45
   17, // 46
   17, // 47
   18, // 48
   18, // 49
   19, // 50
   19, // 51
   20, // 52
   21, // 53
   21, // 54
   22, // 55
   23, // 56
   23, // 57
   24, // 58
   25, // 59
   25, // 60
   26, // 61
   27, // 62
   27, // 63
   28, // 64
   29, // 65
   29, // 66
   30, // 67
   31, // 68
   32, // 69
   32, // 70
   33, // 71
   34, // 72
   35, // 73
   35, // 74
   36, // 75
   37, // 76
   38, // 77
   38, // 78
   39, // 79
   40, // 80
   41, // 81
   42, // 82
   42, // 83
   43, // 84
   44, // 85
   45, // 86
   46, // 87
   47, // 88
   48, // 89
   48, // 90
   49, // 91
   50, // 92
   51, // 93
   52, // 94
   53, // 95
   54, // 96
   55, // 97
   55, // 98
   56, // 99
   57, // 100
   58, // 101
   59, // 102
   60, // 103
   61, // 104
   62, // 105
   63, // 106
   64, // 107
   65, // 108
   66, // 109
   67, // 110
   68, // 111
   69, // 112
   70, // 113
   71, // 114
   72, // 115
   73, // 116
   74, // 117
   75, // 118
   76, // 119
   77, // 120
   78, // 121
   79, // 122
   80, // 123
   81, // 124
   82, // 125
   83, // 126
   84, // 127
   85, // 128
   86, // 129
   87, // 130
   88, // 131
   89, // 132
   90, // 133
   91, // 134
   93, // 135
   94, // 136
   95, // 137
   96, // 138
   97, // 139
   98, // 140
   99, // 141
  100, // 142
  101, // 143
  103, // 144
  104, // 145
  105, // 146
  106, // 147
  107, // 148
  108, // 149
  110, // 150
  111, // 151
  112, // 152
  113, // 153
  114, // 154
  115, // 155
  117, // 156
  118, // 157
  119, // 158
  120, // 159
  121, // 160
  123, // 161
  124, // 162
  125, // 163
  126, // 164
  128, // 165
  129, // 166
  130, // 167
  131, // 168
  133, // 169
  134, // 170
  135, // 171
  136, // 172
  138, // 173
  139, // 174
  140, // 175
  141, // 176
  143, // 177
  144, // 178
  145, // 179
  147, // 180
  148, // 181
  149, // 182
  151, // 183
  152, // 184
  153, // 185
  155, // 186
  156, // 187
  157, // 188
  159, // 189
  160, // 190
  161, // 191
  163, // 192
  164, // 193
  165, // 194
  167, // 195
  168, // 196
  169, // 197
  171, // 198
  172, // 199
  174, // 200
  175, // 201
  176, // 202
  178, // 203
  179, // 204
  181, // 205
  182, // 206
  183, // 207
  185, // 208
  186, // 209
  188, // 210
  189, // 211
  191, // 212
  192, // 213
  193, // 214
  195, // 215
  196, // 216
  198, // 217
  199, // 218
  201, // 219
  202, // 220
  204, // 221
  205, // 222
  207, // 223
  208, // 224
  210, // 225
  211, // 226
  213, // 227
  214, // 228
  216, // 229
  217, // 230
  219, // 231
  220, // 232
  222, // 233
  223, // 234
  225, // 235
  226, // 236
  228, // 237
  229, // 238
  231, // 239
  232, // 240
  234, // 241
  235, // 242
  237, // 243
  239, // 244
  240, // 245
  242, // 246
  243, // 247
  245, // 248
  246, // 249
  248, // 250
  250, // 251
  251, // 252
  253, // 253
  254, // 254
};

// <<<
//*****************************************************************************

void matrix_set_hv(uint8_t x, uint8_t y, uint8_t h, uint8_t v)
{
  uint8_t r = rgb[h][0];
  uint8_t g = rgb[h][1];
  uint8_t b = rgb[h][2];
  if (v < 255)
  {
    uint16_t f = (uint16_t)vf[v];
    r = (uint8_t)(((uint16_t)r * f) >> 8);
    g = (uint8_t)(((uint16_t)g * f) >> 8);
    b = (uint8_t)(((uint16_t)b * f) >> 8);
  }
  matrix_set_rgb(x, y, r, g, b);
}

//*****************************************************************************

void matrix_set_g(uint8_t x, uint8_t y, uint8_t v)
{
  matrix_set_rgb(x, y, v, v, v);
}

//*****************************************************************************